<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.esuizhen.cloudservice.ehr.dao.inhospital.PatientClinicInfoDao" >
  
  <sql id="Base_Column_List">
  	t1.clinicMedicalId,
  	t1.emrId,
  	t1.patientId,
  	t1.hospitalId,
  	t1.visitTimes,
  	t1.visitTime,
  	t1.healthCardNo,
  	t1.patientName,
  	t1.patientIdno,
  	t1.patientAddress,
  	t1.patientMobile,
  	(select it2.sex FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) patientSex,
  	(select nationId FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) nationId ,
    (select nation FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) nation ,
  	t1.patientBirth,
  	t1.patientAge,
  	t1.deptId,
  	t1.catalogState,
  	t1.catalogDate,
  	case when t1.hospitalId is not null then (SELECT hospitalName FROM user_db.u_hospital WHERE hospitalId=t1.hospitalId) else t1.hospitalName end hospitalName,
  	t1.patientNo,
  	t1.clinicNo,
  	t1.visitTime,
  	case when t1.deptId is null then t1.deptName else (select deptName from user_db.u_department where deptId=t1.deptId) end deptName,
  	t1.attendingDoctorId,
  	case when t1.attendingDoctorId is null then attendingDoctorName else (SELECT trueName FROM user_db.u_doctor WHERE doctorId=t1.attendingDoctorId) end attendingDoctorName,
  	t1.diagnosis mainDiagnosis,
  	t1.diseaseCode mainDiseaseCode,
  	medicalPayType,
  	nationalityId,
  	(select nationalityName FROM user_db.meta_nationality it1 WHERE nationalityId=t1.nationalityId) nationalityName,
  	babyAge,
  	babyBornWeight,
  	babyWeightInHospital,
  	(SELECT provinceCode FROM user_db.meta_county WHERE cityCode=t1.nativePlaceCityCode LIMIT 1) nativePlaceProvinceCode,
  	nativePlaceCityCode,
  	nativePlaceAddress,
  	(select occupationName FROM user_db.meta_occupation it1 WHERE occupationId=t1.occupationId) occupationName,
  	occupationId,
  	marriageStatus,
  	liveZipCode,
  	liveAddress,
  	liveTel,
  	(SELECT provinceCode FROM user_db.meta_county WHERE countyCode=t1.liveCountyCode) liveProvinceCode,
  	(SELECT cityCode FROM user_db.meta_county WHERE countyCode=t1.liveCountyCode) liveCityCode,
  	liveCountyCode,
  	(SELECT provinceCode FROM user_db.meta_county WHERE countyCode=t1.householdCountyCode) householdProvinceCode,
  	(SELECT cityCode FROM user_db.meta_county WHERE countyCode=t1.householdCountyCode) householdCityCode,
  	householdCountyCode,
  	householdZipCode,
  	householdAddress,
  	companyZipCode,
  	companyAddress,
  	(SELECT provinceCode FROM user_db.meta_county WHERE countyCode=t1.companyCountyCode) companyProvinceCode,
  	(SELECT cityCode FROM user_db.meta_county WHERE countyCode=t1.companyCountyCode) companyCityCode,
  	companyCountyCode,
  	companyTel,
  	familyTel,
  	(SELECT provinceCode FROM user_db.meta_county WHERE countyCode=t1.familyCountyCode) familyProvinceCode,
  	(SELECT cityCode FROM user_db.meta_county WHERE countyCode=t1.familyCountyCode) familyCityCode,
  	familyCountyCode,
  	familyAddress,
  	familyName,
  	patientRelation,
  	(select birthPlaceCode FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) birthPlaceCountyCode ,
    (select it3.cityCode FROM user_db.u_patient it1 , user_db.u_user it2 , user_db.meta_county it3 WHERE it1.userId=it2.userId AND it2.birthPlaceCode = it3.countyCode AND it1.patientId=t1.patientId) birthPlaceCityCode ,
    (select it3.provinceCode FROM user_db.u_patient it1 , user_db.u_user it2 , user_db.meta_county it3 WHERE it1.userId=it2.userId AND it2.birthPlaceCode = it3.countyCode AND it1.patientId=t1.patientId) birthPlaceProvinceCode ,
    (select birthPlaceAddress FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) birthPlaceAddress ,
  	pathologyDiagnosis,
  	pathologyDiagnosisCode,
  	pathologyNo,
  	tumourPeriodization,
  	tumourPeriodizationT,
  	tumourPeriodizationN,
  	tumourPeriodizationM1,
  	tumourPeriodizationClinic,
  	isAllergy,allergyDesc,
  	aboBlood,
  	rhBlood,
  	redBloodCell,
  	platelet,
  	plasma,
  	wholeBlood,
  	other,
  	adverseReactionWriteTime,
  	clinicWard,
  	clinicWay,
  	t1.deptDoctor,
	case when t1.deptDoctor is null then deptDoctorName else (SELECT trueName FROM user_db.u_doctor WHERE doctorId=t1.deptDoctor) end deptDoctorName,
	t1.directorDoctor,
	case when t1.directorDoctor is null then directorDoctorName else (SELECT trueName FROM user_db.u_doctor WHERE doctorId=t1.directorDoctor) end directorDoctorName
  </sql>
  
  <sql id="Base_Column_One">
  	t1.clinicMedicalId,
  	t1.emrId,
  	t1.patientId,
  	t1.hospitalId,
  	t1.visitTimes,
  	t1.visitTime,
  	t1.healthCardNo,
  	t1.patientName,
  	t1.patientIdno,
  	t1.patientAddress,
  	t1.patientMobile,
  	(select it2.sex FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) patientSex,
  	(select nationId FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) nationId ,
    (select nation FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) nation ,
  	t1.patientBirth,
  	t1.patientAge,
  	t1.deptId,
  	t1.catalogState,
  	t1.catalogDate,
  	case when t1.hospitalId is not null then (SELECT hospitalName FROM user_db.u_hospital WHERE hospitalId=t1.hospitalId) else t1.hospitalName end hospitalName,
  	t1.patientNo,
  	t1.clinicNo,
  	t1.visitTime,
  	case when t1.deptId is null then t1.deptName else (select deptName from user_db.u_department where deptId=t1.deptId) end deptName,
  	t1.attendingDoctorId,
  	case when t1.attendingDoctorId is null then attendingDoctorName else (SELECT trueName FROM user_db.u_doctor WHERE doctorId=t1.attendingDoctorId) end attendingDoctorName,
  	t1.diagnosis diagnose,
  	t1.diseaseCode,
  	medicalPayType,
  	nationalityId,
  	(select nationalityName FROM user_db.meta_nationality it1 WHERE nationalityId=t1.nationalityId) nationalityName,
  	babyAge,
  	babyBornWeight,
  	babyWeightInHospital,
  	<!-- (SELECT provinceCode FROM user_db.meta_county WHERE cityCode=t1.nativePlaceCityCode LIMIT 1) nativePlaceProvinceCode,
  	 -->nativePlaceCityCode,
  	nativePlaceAddress,
  	(select occupationName FROM user_db.meta_occupation it1 WHERE occupationId=t1.occupationId) occupationName,
  	occupationId,
  	marriageStatus,
  	liveZipCode,
  	liveAddress,
  	liveTel,
  	<!-- (SELECT provinceCode FROM user_db.meta_county WHERE countyCode=t1.liveCountyCode) liveProvinceCode,
  	(SELECT cityCode FROM user_db.meta_county WHERE countyCode=t1.liveCountyCode) liveCityCode,
  	 -->
  	 liveProvinceCode,
  	 liveCityCode,
  	 liveCountyCode,
  	<!-- (SELECT provinceCode FROM user_db.meta_county WHERE countyCode=t1.householdCountyCode) householdProvinceCode,
  	(SELECT cityCode FROM user_db.meta_county WHERE countyCode=t1.householdCountyCode) householdCityCode,
  	 -->
  	householdProvinceCode,
  	householdCityCode,
  	householdCountyCode,
  	householdZipCode,
  	householdAddress,
  	companyZipCode,
  	companyAddress,
  	<!-- (SELECT provinceCode FROM user_db.meta_county WHERE countyCode=t1.companyCountyCode) companyProvinceCode,
  	(SELECT cityCode FROM user_db.meta_county WHERE countyCode=t1.companyCountyCode) companyCityCode,
  	 -->
  	companyProvinceCode,
  	companyCityCode,
  	companyCountyCode,
  	companyTel,
  	familyTel,
  	<!-- (SELECT provinceCode FROM user_db.meta_county WHERE countyCode=t1.familyCountyCode) familyProvinceCode,
  	(SELECT cityCode FROM user_db.meta_county WHERE countyCode=t1.familyCountyCode) familyCityCode,
  	 -->
  	familyProvinceCode,
  	familyCityCode,
  	familyCountyCode,
  	familyAddress,
  	familyName,
  	patientRelation,
  	(select birthPlaceCode FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) birthPlaceCountyCode ,
    <!-- (select it3.cityCode FROM user_db.u_patient it1 , user_db.u_user it2 , user_db.meta_county it3 WHERE it1.userId=it2.userId AND it2.birthPlaceCode = it3.countyCode AND it1.patientId=t1.patientId) birthPlaceCityCode ,
    (select it3.provinceCode FROM user_db.u_patient it1 , user_db.u_user it2 , user_db.meta_county it3 WHERE it1.userId=it2.userId AND it2.birthPlaceCode = it3.countyCode AND it1.patientId=t1.patientId) birthPlaceProvinceCode ,
     -->(select birthPlaceAddress FROM user_db.u_patient it1 , user_db.u_user it2 WHERE it1.userId=it2.userId AND it1.patientId=t1.patientId) birthPlaceAddress ,
  	pathologyDiagnosis,
  	pathologyDiagnosisCode,
  	pathologyNo,
  	tumourPeriodization,
  	tumourPeriodizationT,
  	tumourPeriodizationN,
  	tumourPeriodizationM1,
  	(SELECT m.disagnosisPeriodizationName from ehr_db.meta_e_diagnosis_periodization m where m.disagnosisPeriodizationId=t1.tumourPeriodizationClinicId LIMIT 1) tumourPeriodizationClinic,
  	tumourPeriodizationTId,
    tumourPeriodizationNId,
    tumourPeriodizationM1Id,
    tumourPeriodizationClinicId,
  	isAllergy,allergyDesc,
  	aboBlood,
  	rhBlood,
  	redBloodCell,
  	platelet,
  	plasma,
  	wholeBlood,
  	other,
  	adverseReactionWriteTime,
  	clinicWard,
  	clinicWay,
  	t1.deptDoctor,
	case when t1.deptDoctor is null then deptDoctorName else (SELECT trueName FROM user_db.u_doctor WHERE doctorId=t1.deptDoctor) end deptDoctorName,
	t1.directorDoctor,
	case when t1.directorDoctor is null then directorDoctorName else (SELECT trueName FROM user_db.u_doctor WHERE doctorId=t1.directorDoctor) end directorDoctorName
  </sql>
  
  <sql id="Where_Condition">
  	<where>
  		t1.patientId=#{patientId}
	  	<if test="clinicDateStart != null">
	  		<![CDATA[
	  		AND t1.visitTime>=#{clinicDateStart}
	  		]]>
	  	</if>
	  	<if test="clinicDateEnd != null">
	  		<![CDATA[
	  		AND t1.visitTime<=#{clinicDateEnd}
	  		]]>
	  	</if>
  	</where>
  </sql>
  
  <select id="queryList" resultType="com.esuizhen.cloudservice.ehr.model.inhospital.PatientClinicInfo" parameterType="java.util.Map">
  	SELECT <include refid="Base_Column_List"></include>,t2.treatmentName,t2.treatmentTypeName 
  	FROM ehr_db.ec_clinic_medical_note t1
  	left join (SELECT clinicMedicalId,GROUP_CONCAT(treatmentName) treatmentName,GROUP_CONCAT(treatmentTypeName) treatmentTypeName FROM ehr_db.eci_treatment_note WHERE patientId=#{patientId} GROUP BY clinicMedicalId) t2 on t1.clinicMedicalId=t2.clinicMedicalId 
  	<include refid="Where_Condition"></include>
  	ORDER BY t1.visitTime DESC,t1.createTime DESC
  	<if test="startRow != null">
		LIMIT #{startRow},#{pageSize}
	</if>
  </select>
  
  <select id="queryOne" resultType="com.esuizhen.cloudservice.ehr.model.inhospital.PatientClinicInfo">
  	SELECT <include refid="Base_Column_One"></include> 
  	FROM ehr_db.ec_clinic_medical_note t1 WHERE t1.clinicMedicalId=#{clinicMedicalId}
  </select>
  
  <insert id="insert" parameterType="com.esuizhen.cloudservice.ehr.model.inhospital.PatientClinicInfo">
  	INSERT INTO ehr_db.ec_clinic_medical_note(
		clinicMedicalId,
		emrId,
		<if test="clinicNo != null">
			clinicNo,
		</if>
		patientId,
		patientNo,
		hospitalId,
		hospitalName,
		healthCardNo,
		patientName,
		patientIdno,
		patientAddress,
		patientMobile,
		patientSex,
		patientBirth,
		patientAge,
		deptId,
		deptName,
		attendingDoctorId,
		attendingDoctorName,
		symptomSummary,
		diagnosis,
		diseaseCode,
		remark,
		visitTimes,
		visitTime,
		createTime,
		updateTime,
		medicalPayType,
	  	nationalityId,
	  	nationalityName,
	  	babyAge,
	  	babyBornWeight,
	  	babyWeightInHospital,
	  	nativePlaceCityCode,
	  	nativePlaceAddress,
	  	occupationName,
	  	occupationId,
	  	marriageStatus,
	  	liveZipCode,
	  	liveAddress,
	  	liveTel,
	  	liveProvinceCode,
	  	liveCityCode,
	  	liveCountyCode,
	  	householdProvinceCode,
	  	householdCityCode,
	  	householdCountyCode,
	  	householdZipCode,
	  	householdAddress,
	  	companyZipCode,
	  	companyAddress,
	  	companyProvinceCode,
	  	companyCityCode,
	  	companyCountyCode,
	  	companyTel,
	  	familyTel,
	  	familyProvinceCode,
	  	familyCityCode,
	  	familyCountyCode,
	  	familyAddress,
	  	familyName,
	  	patientRelation,
	  	pathologyDiagnosis,
	  	pathologyDiagnosisCode,
	  	pathologyNo,
	  	tumourPeriodization,
	  	tumourPeriodizationT,
	  	tumourPeriodizationN,
	  	tumourPeriodizationM1,
	  	tumourPeriodizationClinic,
	  	isAllergy,
	  	allergyDesc,
	  	aboBlood,
	  	rhBlood,
	  	redBloodCell,
	  	platelet,
	  	plasma,
	  	wholeBlood,
	  	other,
	  	adverseReactionWriteTime,
	  	idType,
	  	clinicWard,
	  	clinicWay,
	  	deptDoctor,
	  	deptDoctorName,
	  	directorDoctor,
	  	directorDoctorName
	) VALUES
	(
		#{clinicMedicalId},
		#{emrId},
		<if test="clinicNo != null">
			#{clinicNo},
		</if>
		#{patientId},
		#{patientNo},
		#{hospitalId},
		#{hospitalName},
		#{healthCardNo},
		#{patientName},
		#{patientIdno},
		#{patientAddress},
		#{patientMobile},
		#{patientSex},
		#{patientBirth},
		#{patientAge},
		#{deptId},
		#{deptName},
		#{attendingDoctorId},
		#{attendingDoctorName},
		#{symptomSummary},
		#{mainDiagnosis},
		#{mainDiseaseCode},
		#{remark},
		#{visitTimes},
		#{visitTime},
		NOW(),
		NOW(),
		#{medicalPayType},
		#{nationalityId},
		#{nationalityName},
		#{babyAge},
		#{babyBornWeight},
		#{babyWeightInHospital},
		#{nativePlaceCityCode},
		#{nativePlaceAddress},
		#{occupationName},
		#{occupationId},
		#{marriageStatus},
		#{liveZipCode},
		#{liveAddress},
		#{liveTel},
		#{liveProvinceCode},
		#{liveCityCode},
		#{liveCountyCode},
		#{householdProvinceCode},
		#{householdCityCode},
		#{householdCountyCode},
		#{householdZipCode},
		#{householdAddress},
		#{companyZipCode},
		#{companyAddress},
		#{companyProvinceCode},
		#{companyCityCode},
		#{companyCountyCode},
		#{companyTel},
		#{familyTel},
		#{familyProvinceCode},
		#{familyCityCode},
		#{familyCountyCode},
		#{familyAddress},
		#{familyName},
		#{patientRelation},
		#{pathologyDiagnosis},
		#{pathologyDiagnosisCode},
		#{pathologyNo},
		#{tumourPeriodization},
		#{tumourPeriodizationT},
		#{tumourPeriodizationN},
		#{tumourPeriodizationM1},
		#{tumourPeriodizationClinic},
		#{isAllergy},
		#{allergyDesc},
		#{aboBlood},
		#{rhBlood},
		#{redBloodCell},
		#{platelet},
		#{plasma},
		#{wholeBlood},
		#{other},
		#{adverseReactionWriteTime},
		#{idType},
		#{clinicWard},
		#{clinicWay},
		#{deptDoctor},
		#{deptDoctorName},
		#{directorDoctor},
		#{directorDoctorName}
	)
  </insert>
  
  <update id="updateByPrimaryKey">
  	update ehr_db.ec_clinic_medical_note set
		emrId=1,
		<if test="clinicNo != null">
			clinicNo=#{clinicNo},
		</if>
		patientId=#{patientId},
		patientNo=#{patientNo},
		hospitalId=#{hospitalId},
		hospitalName=#{hospitalName},
		healthCardNo=#{healthCardNo},
		patientName=#{patientName},
		patientIdno=#{patientIdno},
		patientAddress=#{patientAddress},
		patientMobile=#{patientMobile},
		patientSex=#{patientSex},
		patientBirth=#{patientBirth},
		patientAge=#{patientAge},
		deptId=#{deptId},
		deptName=#{deptName},
		attendingDoctorId=#{attendingDoctorId},
		attendingDoctorName=#{attendingDoctorName},
		symptomSummary=#{symptomSummary},
		diagnosis=#{diagnose},
		diseaseCode=#{diseaseCode},
		remark=#{remark},
		visitTimes=#{visitTimes},
		visitTime=#{visitTime},
		createTime=NOW(),
		updateTime=NOW(),
		medicalPayType=#{medicalPayType},
		nationalityId=#{nationalityId},
		nationalityName=#{nationalityName},
		babyAge=#{babyAge},
		babyBornWeight=#{babyBornWeight},
		babyWeightInHospital=#{babyWeightInHospital},
		nativePlaceCityCode=#{nativePlaceCityCode},
		nativePlaceAddress=#{nativePlaceAddress},
		occupationName=#{occupationName},
		occupationId=#{occupationId},
		marriageStatus=#{marriageStatus},
		liveZipCode=#{liveZipCode},
		liveAddress=#{liveAddress},
		liveTel=#{liveTel},
		liveProvinceCode=#{liveProvinceCode},
		liveCityCode=#{liveCityCode},
		liveCountyCode=#{liveCountyCode},
		householdProvinceCode=#{householdProvinceCode},
		householdCityCode=#{householdCityCode},
		householdCountyCode=#{householdCountyCode},
		householdZipCode=#{householdZipCode},
		householdAddress=#{householdAddress},
		companyZipCode=#{companyZipCode},
		companyAddress=#{companyAddress},
		companyProvinceCode=#{companyProvinceCode},
		companyCityCode=#{companyCityCode},
		companyCountyCode=#{companyCountyCode},
		companyTel=#{companyTel},
		familyTel=#{familyTel},
		familyProvinceCode=#{familyProvinceCode},
		familyCityCode=#{familyCityCode},
		familyCountyCode=#{familyCountyCode},
		familyAddress=#{familyAddress},
		familyName=#{familyName},
		patientRelation=#{patientRelation},
		pathologyDiagnosis=#{pathologyDiagnosis},
		pathologyDiagnosisCode=#{pathologyDiagnosisCode},
		pathologyNo=#{pathologyNo},
		tumourPeriodization=#{tumourPeriodization},
		tumourPeriodizationT=#{tumourPeriodizationT},
		tumourPeriodizationN=#{tumourPeriodizationN},
		tumourPeriodizationM1=#{tumourPeriodizationM1},
		tumourPeriodizationClinic=#{tumourPeriodizationClinic},
		tumourPeriodizationTId = #{tumourPeriodizationTId} ,
        tumourPeriodizationNId = #{tumourPeriodizationNId} ,
        tumourPeriodizationM1Id = #{tumourPeriodizationM1Id} ,
        tumourPeriodizationClinicId = #{tumourPeriodizationClinicId} ,
		isAllergy=#{isAllergy},
		allergyDesc=#{allergyDesc},
		aboBlood=#{aboBlood},
		rhBlood=#{rhBlood},
		redBloodCell=#{redBloodCell},
		platelet=#{platelet},
		plasma=#{plasma},
		wholeBlood=#{wholeBlood},
		other=#{other},
		idType=#{idType},
		clinicWard=#{clinicWard},
		clinicWay=#{clinicWay},
		adverseReactionWriteTime=#{adverseReactionWriteTime},
		deptDoctor=#{deptDoctor},
		deptDoctorName=#{deptDoctorName},
		directorDoctor=#{directorDoctor},
		directorDoctorName=#{directorDoctorName},
		catalogState=2,
        catalogDate = NOW()
	where clinicMedicalId=#{clinicMedicalId}
  </update>
  
  <update id="updateByPrimaryKeySelective">
  	update ehr_db.ec_clinic_medical_note
		<set>
			<if test="catalogState != null">
				catalogState=#{catalogState},
				catalogDate=now(),
			</if>
		</set>
	where clinicMedicalId=#{clinicMedicalId}
  </update>
</mapper>